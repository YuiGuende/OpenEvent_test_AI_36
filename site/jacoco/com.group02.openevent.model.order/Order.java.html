<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Order.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenEvent</a> &gt; <a href="index.source.html" class="el_package">com.group02.openevent.model.order</a> &gt; <span class="el_source">Order.java</span></div><h1>Order.java</h1><pre class="source lang-java linenums">package com.group02.openevent.model.order;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import com.group02.openevent.model.event.Event;
import com.group02.openevent.model.user.Customer;
import com.group02.openevent.model.ticket.TicketType;
import com.group02.openevent.model.voucher.Voucher;
import jakarta.persistence.*;
import java.math.BigDecimal;
import java.time.LocalDateTime;

@Entity
@Table(name = &quot;orders&quot;)
<span class="fc" id="L14">public class Order {</span>

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = &quot;order_id&quot;)
    private Long orderId;

    @ManyToOne(optional = false, fetch = FetchType.LAZY)
    @JoinColumn(name = &quot;customer_id&quot;, nullable = false,
            foreignKey = @ForeignKey(name = &quot;fk_order_customer&quot;))
    @JsonIgnoreProperties({&quot;orders&quot;, &quot;passwordHash&quot;, &quot;account&quot;})
    private Customer customer;

    @ManyToOne(optional = false, fetch = FetchType.LAZY)
    @JoinColumn(name = &quot;event_id&quot;, nullable = false,
            foreignKey = @ForeignKey(name = &quot;fk_order_event&quot;))
    @JsonIgnoreProperties({&quot;orders&quot;, &quot;ticketTypes&quot;, &quot;eventImages&quot;, &quot;host&quot;})
    private Event event;

    @ManyToOne(optional = false, fetch = FetchType.LAZY)
    @JoinColumn(name = &quot;ticket_type_id&quot;, nullable = false,
            foreignKey = @ForeignKey(name = &quot;fk_order_tickettype&quot;))
    @JsonIgnoreProperties({&quot;event&quot;, &quot;orders&quot;})
    private TicketType ticketType;

<span class="fc" id="L39">    @Enumerated(EnumType.STRING)</span>
    @Column(name = &quot;status&quot;, nullable = false)
    private OrderStatus status = OrderStatus.PENDING;

<span class="fc" id="L43">    @Column(name = &quot;quantity&quot;, nullable = false)</span>
<span class="fc" id="L44">    private Integer quantity = 1;</span>

    // Pricing fields
    @Column(name = &quot;original_price&quot;, precision = 10, scale = 2, nullable = false)
    private BigDecimal originalPrice;

<span class="fc" id="L50">    @Column(name = &quot;host_discount_percent&quot;, precision = 5, scale = 2)</span>
    private BigDecimal hostDiscountPercent = BigDecimal.ZERO;

<span class="fc" id="L53">    @Column(name = &quot;host_discount_amount&quot;, precision = 10, scale = 2)</span>
    private BigDecimal hostDiscountAmount = BigDecimal.ZERO;

<span class="fc" id="L56">    @Column(name = &quot;voucher_discount_amount&quot;, precision = 10, scale = 2)</span>
    private BigDecimal voucherDiscountAmount = BigDecimal.ZERO;

<span class="fc" id="L59">    @Column(name = &quot;total_amount&quot;, precision = 10, scale = 2, nullable = false)</span>
    private BigDecimal totalAmount = BigDecimal.ZERO;

    // Voucher information
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = &quot;voucher_id&quot;)
    @JsonIgnoreProperties({&quot;voucherUsages&quot;})
    private Voucher voucher;

    @Column(name = &quot;voucher_code&quot;, length = 20)
    private String voucherCode;

    @Column(name = &quot;participant_name&quot;, length = 100)
    private String participantName;

    @Column(name = &quot;participant_email&quot;, length = 100)
    private String participantEmail;

    @Column(name = &quot;participant_phone&quot;, length = 20)
    private String participantPhone;

    @Column(name = &quot;participant_organization&quot;, length = 150)
    private String participantOrganization;

    @Column(name = &quot;notes&quot;, length = 1000)
    private String notes;

<span class="fc" id="L86">    @Column(name = &quot;created_at&quot;, nullable = false)</span>
<span class="fc" id="L87">    private LocalDateTime createdAt = LocalDateTime.now();</span>

    @Column(name = &quot;updated_at&quot;)
    private LocalDateTime updatedAt;

    @PreUpdate
    protected void onUpdate() {
<span class="nc" id="L94">        updatedAt = LocalDateTime.now();</span>
<span class="nc" id="L95">    }</span>

    // Business Logic Methods
    public void calculateTotalAmount() {
<span class="fc bfc" id="L99" title="All 2 branches covered.">        if (ticketType != null) {</span>
            // Calculate original price for the quantity
<span class="fc" id="L101">            this.originalPrice = ticketType.getPrice().multiply(new BigDecimal(quantity));</span>
            
            // Calculate host discount amount
<span class="pc bpc" id="L104" title="1 of 4 branches missed.">            if (hostDiscountPercent != null &amp;&amp; hostDiscountPercent.compareTo(BigDecimal.ZERO) &gt; 0) {</span>
<span class="fc" id="L105">                this.hostDiscountAmount = originalPrice.multiply(hostDiscountPercent.divide(new BigDecimal(&quot;100&quot;)));</span>
            }
            
            // Calculate price after discounts
<span class="fc" id="L109">            BigDecimal priceAfterDiscounts = originalPrice.subtract(hostDiscountAmount).subtract(voucherDiscountAmount);</span>
            
            // Ensure price after discounts is not negative
<span class="fc bfc" id="L112" title="All 2 branches covered.">            if (priceAfterDiscounts.compareTo(BigDecimal.ZERO) &lt; 0) {</span>
<span class="fc" id="L113">                priceAfterDiscounts = BigDecimal.ZERO;</span>
            }
            
            // Calculate VAT (10%) on price after discounts
<span class="fc" id="L117">            BigDecimal vat = priceAfterDiscounts.multiply(new BigDecimal(&quot;0.10&quot;));</span>
            
            // Final total amount = price after discounts + VAT
<span class="fc" id="L120">            this.totalAmount = priceAfterDiscounts.add(vat);</span>
            
            
<span class="fc" id="L123">        } else {</span>
<span class="fc" id="L124">            this.originalPrice = BigDecimal.ZERO;</span>
<span class="fc" id="L125">            this.totalAmount = BigDecimal.ZERO;</span>
        }
<span class="fc" id="L127">    }</span>

<span class="fc" id="L129">    public Long getOrderId() { return orderId; }</span>
<span class="fc" id="L130">    public void setOrderId(Long orderId) { this.orderId = orderId; }</span>

<span class="fc" id="L132">    public Customer getCustomer() { return customer; }</span>
<span class="fc" id="L133">    public void setCustomer(Customer customer) { this.customer = customer; }</span>

<span class="fc" id="L135">    public Event getEvent() { return event; }</span>
<span class="fc" id="L136">    public void setEvent(Event event) { this.event = event; }</span>

<span class="nc" id="L138">    public TicketType getTicketType() { return ticketType; }</span>
    public void setTicketType(TicketType ticketType) { 
<span class="fc" id="L140">        this.ticketType = ticketType; </span>
<span class="fc" id="L141">        calculateTotalAmount();</span>
<span class="fc" id="L142">    }</span>

<span class="fc" id="L144">    public OrderStatus getStatus() { return status; }</span>
<span class="fc" id="L145">    public void setStatus(OrderStatus status) { this.status = status; }</span>

<span class="fc" id="L147">    public BigDecimal getTotalAmount() { return totalAmount; }</span>
<span class="fc" id="L148">    public void setTotalAmount(BigDecimal totalAmount) { this.totalAmount = totalAmount; }</span>

<span class="nc" id="L150">    public String getParticipantName() { return participantName; }</span>
<span class="fc" id="L151">    public void setParticipantName(String participantName) { this.participantName = participantName; }</span>

<span class="nc" id="L153">    public String getParticipantEmail() { return participantEmail; }</span>
<span class="fc" id="L154">    public void setParticipantEmail(String participantEmail) { this.participantEmail = participantEmail; }</span>

<span class="nc" id="L156">    public String getParticipantPhone() { return participantPhone; }</span>
<span class="fc" id="L157">    public void setParticipantPhone(String participantPhone) { this.participantPhone = participantPhone; }</span>

<span class="nc" id="L159">    public String getParticipantOrganization() { return participantOrganization; }</span>
<span class="fc" id="L160">    public void setParticipantOrganization(String participantOrganization) { this.participantOrganization = participantOrganization; }</span>

<span class="nc" id="L162">    public String getNotes() { return notes; }</span>
<span class="fc" id="L163">    public void setNotes(String notes) { this.notes = notes; }</span>

<span class="nc" id="L165">    public LocalDateTime getCreatedAt() { return createdAt; }</span>
<span class="nc" id="L166">    public void setCreatedAt(LocalDateTime createdAt) { this.createdAt = createdAt; }</span>

<span class="nc" id="L168">    public LocalDateTime getUpdatedAt() { return updatedAt; }</span>
<span class="fc" id="L169">    public void setUpdatedAt(LocalDateTime updatedAt) { this.updatedAt = updatedAt; }</span>

    // New getters and setters for pricing fields
<span class="fc" id="L172">    public BigDecimal getOriginalPrice() { return originalPrice; }</span>
<span class="fc" id="L173">    public void setOriginalPrice(BigDecimal originalPrice) { this.originalPrice = originalPrice; }</span>

<span class="fc" id="L175">    public BigDecimal getHostDiscountPercent() { return hostDiscountPercent; }</span>
    public void setHostDiscountPercent(BigDecimal hostDiscountPercent) { 
<span class="fc" id="L177">        this.hostDiscountPercent = hostDiscountPercent; </span>
<span class="fc" id="L178">        calculateTotalAmount();</span>
<span class="fc" id="L179">    }</span>

<span class="fc" id="L181">    public BigDecimal getHostDiscountAmount() { return hostDiscountAmount; }</span>
<span class="nc" id="L182">    public void setHostDiscountAmount(BigDecimal hostDiscountAmount) { this.hostDiscountAmount = hostDiscountAmount; }</span>

<span class="fc" id="L184">    public BigDecimal getVoucherDiscountAmount() { return voucherDiscountAmount; }</span>
    public void setVoucherDiscountAmount(BigDecimal voucherDiscountAmount) { 
<span class="fc" id="L186">        this.voucherDiscountAmount = voucherDiscountAmount; </span>
<span class="fc" id="L187">        calculateTotalAmount();</span>
<span class="fc" id="L188">    }</span>

<span class="fc" id="L190">    public Voucher getVoucher() { return voucher; }</span>
<span class="fc" id="L191">    public void setVoucher(Voucher voucher) { this.voucher = voucher; }</span>

<span class="nc" id="L193">    public String getVoucherCode() { return voucherCode; }</span>
<span class="fc" id="L194">    public void setVoucherCode(String voucherCode) { this.voucherCode = voucherCode; }</span>

<span class="nc" id="L196">    public Integer getQuantity() { return quantity; }</span>
    public void setQuantity(Integer quantity) { 
<span class="nc" id="L198">        this.quantity = quantity; </span>
<span class="nc" id="L199">        calculateTotalAmount();</span>
<span class="nc" id="L200">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>